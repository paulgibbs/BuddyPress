window.bp=window.bp||{},function(t,e){"undefined"!=typeof BP_Nouveau&&(bp.Nouveau=bp.Nouveau||{},bp.Nouveau.Activity={start:function(){this.setupGlobals(),this.addListeners()},setupGlobals:function(){this.just_posted=[],this.current_page=1,this.mentions_count=Number(e(bp.Nouveau.objectNavParent+' [data-bp-scope="mentions"]').find("a span").html())||0,this.heartbeat_data={newest:"",highlights:{},last_recorded:0,first_recorded:0,document_title:e(document).prop("title")}},addListeners:function(){e("#buddypress").on("bp_heartbeat_send",this.heartbeatSend.bind(this)),e("#buddypress").on("bp_heartbeat_tick",this.heartbeatTick.bind(this)),e('#buddypress [data-bp-list="activity"]').on("click","li.load-newest, li.load-more",this.injectActivities.bind(this)),e("#buddypress").on("bp_ajax_request",'[data-bp-list="activity"]',this.scopeLoaded.bind(this)),e('#buddypress [data-bp-list="activity"]').on("bp_ajax_append",this.hideComments),e('#buddypress [data-bp-list="activity"]').on("click",".show-all",this.showComments),e('#buddypress [data-bp-list="activity"]').on("click",".activity-item",bp.Nouveau,this.activityActions),e(document).keydown(this.commentFormAction)},heartbeatSend:function(t,a){this.heartbeat_data.first_recorded=e("#buddypress [data-bp-list] [data-bp-activity-id] time").first().data("bp-timestamp")||0,(0===this.heartbeat_data.last_recorded||this.heartbeat_data.first_recorded>this.heartbeat_data.last_recorded)&&(this.heartbeat_data.last_recorded=this.heartbeat_data.first_recorded),a.bp_activity_last_recorded=this.heartbeat_data.last_recorded,e("#buddypress .dir-search input[type=search]").length&&(a.bp_activity_last_recorded_search_terms=e("#buddypress .dir-search input[type=search]").val()),e.extend(a,{bp_heartbeat:bp.Nouveau.getStorage("bp-activity")}),e.each(e("#buddypress time"),function(t,a){e(a).data("bp-timestamp")&&e(a).html(bp.Nouveau.updateTimeSince(Number(e(a).data("bp-timestamp"))))})},heartbeatTick:function(t,a){var i,s,n=bp.Nouveau.objects,d=bp.Nouveau.getStorage("bp-activity","scope"),o=this;if(void 0!==a&&a.bp_activity_newest_activities){if(this.heartbeat_data.newest=e.trim(a.bp_activity_newest_activities.activities)+this.heartbeat_data.newest,this.heartbeat_data.last_recorded=Number(a.bp_activity_newest_activities.last_recorded),s=e(this.heartbeat_data.newest).filter(".activity-item"),i=Number(s.length),n.push("mentions"),"all"===d){e.each(s,function(t,a){a=e(a),e.each(n,function(t,i){-1!==e.inArray("bp-my-"+i,a.get(0).classList)&&(void 0===o.heartbeat_data.highlights[i]?o.heartbeat_data.highlights[i]=[a.data("bp-activity-id")]:-1===e.inArray(a.data("bp-activity-id"),o.heartbeat_data.highlights[i])&&o.heartbeat_data.highlights[i].push(a.data("bp-activity-id")))})});var r=new RegExp("bp-my-("+n.join("|")+")","g");this.heartbeat_data.newest=this.heartbeat_data.newest.replace(r,""),e(bp.Nouveau.objectNavParent+' [data-bp-scope="all"]').find("a span").html(i)}else this.heartbeat_data.highlights[d]=[],e.each(s,function(t,a){o.heartbeat_data.highlights[d].push(e(a).data("bp-activity-id"))});if(e.each(n,function(t,a){if(void 0!==o.heartbeat_data.highlights[a]&&o.heartbeat_data.highlights[a].length){var i=0;"mentions"===a&&(i=o.mentions_count),e(bp.Nouveau.objectNavParent+' [data-bp-scope="'+a+'"]').find("a span").html(Number(o.heartbeat_data.highlights[a].length)+i)}}),n.pop(),e(document).prop("title","("+i+") "+this.heartbeat_data.document_title),e('#buddypress [data-bp-list="activity"] li').first().hasClass("load-newest")){var c=e('#buddypress [data-bp-list="activity"] .load-newest a').html();e('#buddypress [data-bp-list="activity"] .load-newest a').html(c.replace(/([0-9]+)/,i))}else e('#buddypress [data-bp-list="activity"]').prepend('<li class="load-newest"><a href="#newest">'+BP_Nouveau.newest+" ("+i+")</a></li>");e('#buddypress [data-bp-list="activity"]').trigger("bp_heartbeat_pending",this.heartbeat_data)}},injectActivities:function(t){var a=bp.Nouveau.getStorage("bp-activity"),i=a.scope||null,s=a.filter||null;if(e(t.currentTarget).hasClass("load-newest")){t.preventDefault(),e(t.currentTarget).remove();var n=e.parseHTML(this.heartbeat_data.newest);e.each(n,function(t,a){"LI"===a.nodeName&&e(a).hasClass("just-posted")&&e("#"+e(a).prop("id")).length&&e("#"+e(a).prop("id")).remove()}),e(t.delegateTarget).prepend(this.heartbeat_data.newest).trigger("bp_heartbeat_prepend",this.heartbeat_data),this.heartbeat_data.newest="","all"===i&&e(bp.Nouveau.objectNavParent+' [data-bp-scope="all"]').find("a span").html(""),"mentions"===i&&(bp.Nouveau.ajax({action:"activity_clear_new_mentions"},"activity"),this.mentions_count=0),e(bp.Nouveau.objectNavParent+' [data-bp-scope="'+i+'"]').find("a span").html(""),void 0!==this.heartbeat_data.highlights[i]&&(this.heartbeat_data.highlights[i]=[]),setTimeout(function(){e(t.delegateTarget).find("[data-bp-activity-id]").removeClass("newest_"+i+"_activity")},3e3),e(document).prop("title",this.heartbeat_data.document_title)}else if(e(t.currentTarget).hasClass("load-more")){var d=1*Number(this.current_page)+1,o=this,r="";t.preventDefault(),e(t.currentTarget).find("a").first().addClass("loading"),this.just_posted=[],e(t.delegateTarget).children(".just-posted").each(function(){o.just_posted.push(e(this).data("bp-activity-id"))}),e("#buddypress .dir-search input[type=search]").length&&(r=e("#buddypress .dir-search input[type=search]").val()),bp.Nouveau.objectRequest({object:"activity",scope:i,filter:s,search_terms:r,page:d,method:"append",exclude_just_posted:this.just_posted.join(",")}).done(function(a){!0===a.success&&(e(t.currentTarget).remove(),o.current_page=d)})}},hideComments:function(t){var a,i,s,n,d=e(t.target).find(".activity-comments");d.length&&d.each(function(t,d){n=e(d).children("ul"),(i=e(n).find("li")).length&&(a=e(d).closest(".activity-item"),s=e("#acomment-comment-"+a.data("bp-activity-id")+" span.comment-count").html()||" ",i.each(function(t,n){t<i.length-5&&(e(n).addClass("bp-hidden").hide(),t||e(n).before('<li class="show-all"><a href="#'+a.prop("id")+'/show-all/">'+BP_Nouveau.show_x_comments.replace("%d",s)+"</a></li>"))}),e(n).children(".bp-hidden").length===e(n).children("li").length-1&&e(n).find("li.show-all")&&e(n).children("li").last().removeClass("bp-hidden").toggle())})},showComments:function(t){t.preventDefault(),e(t.target).addClass("loading"),setTimeout(function(){e(t.target).closest("ul").find("li").removeClass("bp-hidden").fadeIn(200,function(){e(t.target).parent("li").remove()})},600)},scopeLoaded:function(t,a){this.hideComments(t),"mentions"===a.scope&&void 0!==a.response.new_mentions?(e.each(a.response.new_mentions,function(t,a){e("#buddypress #activity-stream").find('[data-bp-activity-id="'+a+'"]').addClass("newest_mentions_activity")}),this.mentions_count=0):void 0!==this.heartbeat_data.highlights[a.scope]&&this.heartbeat_data.highlights[a.scope].length&&e.each(this.heartbeat_data.highlights[a.scope],function(t,i){e("#buddypress #activity-stream").find('[data-bp-activity-id="'+i+'"]').length&&e("#buddypress #activity-stream").find('[data-bp-activity-id="'+i+'"]').addClass("newest_"+a.scope+"_activity")}),this.heartbeat_data.newest="",e(bp.Nouveau.objectNavParent+' [data-bp-scope="all"]').find("a span").html(""),void 0!==this.heartbeat_data.highlights[a.scope]&&(this.heartbeat_data.highlights[a.scope]=[]),e(document).prop("title",this.heartbeat_data.document_title),setTimeout(function(){e("#buddypress #activity-stream .activity-item").removeClass("newest_"+a.scope+"_activity")},3e3)},activityActions:function(t){var a,i,s=t.data,n=e(t.target),d=e(t.currentTarget),o=d.data("bp-activity-id"),r=e(t.delegateTarget);if(e(n).is("span")&&(n=e(n).closest("a")),n.hasClass("fav")||n.hasClass("unfav")){var c=n.hasClass("fav")?"fav":"unfav";t.preventDefault(),n.addClass("loading"),s.ajax({action:"activity_mark_"+c,id:o},"activity").done(function(t){if(n.removeClass("loading"),!1!==t.success)if(n.fadeOut(200,function(){e(this).find("span").first().length?e(this).find("span").first().html(t.data.content):e(this).html(t.data.content),e(this).prop("title",t.data.content),"false"===e(this).attr("aria-pressed")?e(this).attr("aria-pressed","true"):e(this).attr("aria-pressed","false"),e(this).fadeIn(200)}),"fav"===c)void 0!==t.data.directory_tab&&(e(s.objectNavParent+' [data-bp-scope="favorites"]').length||e(s.objectNavParent+' [data-bp-scope="all"]').after(t.data.directory_tab)),n.removeClass("fav"),n.addClass("unfav");else if("unfav"===c){var a=e('[data-bp-user-scope="favorites"]').hasClass("selected")||e(s.objectNavParent+' [data-bp-scope="favorites"]').hasClass("selected");a&&d.remove(),void 0!==t.data.no_favorite&&(e(s.objectNavParent+' [data-bp-scope="all"]').length&&e(s.objectNavParent+' [data-bp-scope="all"]').hasClass("selected")?e(s.objectNavParent+' [data-bp-scope="favorites"]').remove():a&&r.append(t.data.no_favorite)),n.removeClass("unfav"),n.addClass("fav")}})}if(n.hasClass("delete-activity")||n.hasClass("acomment-delete")||n.hasClass("spam-activity")||n.hasClass("spam-activity-comment")){var l,p,h,m,b=n.closest("[data-bp-activity-comment-id]"),u=b.data("bp-activity-comment-id"),v=0;if(t.preventDefault(),void 0!==BP_Nouveau.confirm&&!1===window.confirm(BP_Nouveau.confirm))return!1;n.addClass("loading");var f={action:"delete_activity",id:o,_wpnonce:s.getLinkParams(n.prop("href"),"_wpnonce"),is_single:n.closest("[data-bp-single]").length};(n.hasClass("spam-activity")||n.hasClass("spam-activity-comment"))&&(f.action="bp_spam_activity"),l=d,u&&(delete f.is_single,f.id=u,f.is_comment=!0,l=b),s.ajax(f,"activity").done(function(t){if(n.removeClass("loading"),!1===t.success)l.prepend(t.data.feedback),l.find(".bp-feedback").hide().fadeIn(300);else{if(t.data.redirect)return window.location.href=t.data.redirect;u&&(v=1,d.append(b.find("form")),e.each(b.find("li"),function(){v+=1}),p=d.find(".acomment-reply span.comment-count"),h=Number(p.html()-v),p.html(h),(m=d.find("li.show-all a")).length&&m.html(BP_Nouveau.show_x_comments.replace("%d",h)),0===h&&d.removeClass("has-comments")),l.slideUp(300,function(){l.remove()}),u||d.find("time").first().data("bp-timestamp")!==s.Activity.heartbeat_data.last_recorded||(s.Activity.heartbeat_data.newest="",s.Activity.heartbeat_data.last_recorded=0)}})}if(n.closest("span").hasClass("activity-read-more")){var _=n.closest("div"),y=n.closest("span");if(a=null,e(_).hasClass("activity-inner")?a=o:e(_).hasClass("acomment-content")&&(a=n.closest("li").data("bp-activity-comment-id")),!a)return t;t.preventDefault(),e(y).addClass("loading"),s.ajax({action:"get_single_activity_content",id:a},"activity").done(function(t){e(y).removeClass("loading"),_.parent().find(".bp-feedback").length&&_.parent().find(".bp-feedback").remove(),!1===t.success?(_.after(t.data.feedback),_.parent().find(".bp-feedback").hide().fadeIn(300)):e(_).slideUp(300).html(t.data.contents).slideDown(300)})}if(n.hasClass("acomment-reply")||n.parent().hasClass("acomment-reply")){i=e("#ac-form-"+o),a=o,t.preventDefault(),n.parent().hasClass("acomment-reply")&&n.parent(),n.closest("li").data("bp-activity-comment-id")&&(a=n.closest("li").data("bp-activity-comment-id")),i.removeClass("root"),e(".ac-form").hide(),e.each(i.children("div"),function(t,a){e(a).hasClass("error")&&e(a).remove()}),a===o?(e('[data-bp-activity-id="'+a+'"] .activity-comments').append(i),i.addClass("root")):e('[data-bp-activity-comment-id="'+a+'"]').append(i),i.slideDown(200),n.attr("aria-expanded","true"),e.scrollTo(i,500,{offset:-100,easing:"swing"}),e("#ac-form-"+o+" textarea").focus()}if(n.hasClass("ac-reply-cancel")&&(e(n).closest(".ac-form").slideUp(200),e(".acomment-reply").attr("aria-expanded","false"),t.preventDefault()),"ac_form_submit"===n.prop("name")){var g,w;i=n.closest("form"),a=o,t.preventDefault(),n.closest("li").data("bp-activity-comment-id")&&(a=n.closest("li").data("bp-activity-comment-id")),g=e(i).find("textarea").first(),n.addClass("loading").prop("disabled",!0),g.addClass("loading").prop("disabled",!0),w={action:"new_activity_comment",_wpnonce_new_activity_comment:e("#_wpnonce_new_activity_comment").val(),comment_id:a,form_id:o,content:g.val()},e("#_bp_as_nonce_"+o).val()&&(w["_bp_as_nonce_"+o]=e("#_bp_as_nonce_"+o).val()),s.ajax(w,"activity").done(function(t){if(n.removeClass("loading"),g.removeClass("loading"),e(".acomment-reply").attr("aria-expanded","false"),!1===t.success)i.append(e(t.data.feedback).hide().fadeIn(200));else{var a=i.parent(),s=e.trim(t.data.contents);i.fadeOut(200,function(){0===a.children("ul").length&&(a.hasClass("activity-comments")?a.prepend("<ul></ul>"):a.append("<ul></ul>")),a.children("ul").append(e(s).hide().fadeIn(200)),e(i).find("textarea").first().val(""),a.parent().addClass("has-comments")}),h=Number(e(d).find("a span.comment-count").html()||0)+1,e(d).find("a span.comment-count").html(h),(m=e(d).find(".show-all a"))&&m.html(BP_Nouveau.show_x_comments.replace("%d",h))}n.prop("disabled",!1),g.prop("disabled",!1)})}},commentFormAction:function(t){var a,i;return t=t||window.event,t.target?a=t.target:t.srcElement&&(a=t.srcElement),3===a.nodeType&&(a=a.parentNode),!0===t.altKey||!0===t.metaKey?t:"TEXTAREA"===a.tagName&&e(a).hasClass("ac-input")?void(27===(i=t.keyCode?t.keyCode:t.which)&&!1===t.ctrlKey?"TEXTAREA"===a.tagName&&e(a).closest("form").slideUp(200):t.ctrlKey&&13===i&&e(a).val()&&e(a).closest("form").find("[type=submit]").first().trigger("click")):t}},bp.Nouveau.Activity.start())}(bp,jQuery);